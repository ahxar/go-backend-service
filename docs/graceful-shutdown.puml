@startuml Graceful Shutdown
!theme plain
skinparam sequenceMessageAlign center

actor User
participant "OS" as OS
participant "Signal\nHandler" as Signal
box "cmd/server/main.go" #LightBlue
participant "Main\nGoroutine" as Main
participant "Server\nGoroutine" as ServerGo
end box
box "internal/server" #LightGreen
participant "HTTP\nServer" as Server
end box
participant "In-Flight\nRequests" as Requests

Main -> Signal: signal.NotifyContext(SIGINT, SIGTERM)
activate Signal
note right of Main
  Initialize components:
  config → logger →
  repository → service →
  handler → server
end note
Main -> ServerGo: go srv.ListenAndServe()
activate ServerGo
ServerGo -> Server: Start listening on :8080
activate Server
Main -> Main: <-ctx.Done() [blocking]
note right: Main goroutine blocks,\nwaiting for shutdown signal

== Normal Operation ==

User -> Server: HTTP requests
activate Requests
Server -> Requests: Handle requests
Requests --> Server: Responses
Requests --> User: Responses

== Shutdown Initiated ==

User -> OS: Ctrl+C / SIGTERM
OS -> Signal: Send signal
Signal -> Main: ctx.Done() closes
deactivate Signal
activate Main

Main -> Main: log.Info("shutdown signal received,\nstarting graceful shutdown")
Main -> Main: shutdownCtx = context.WithTimeout(\ncontext.Background(), cfg.ShutdownTimeout)
Main -> Server: srv.Shutdown(shutdownCtx)

Server -> Server: Stop accepting new connections
note right: No new connections accepted

Server -> Requests: Wait for completion
note right: Server waits for\nin-flight requests\n(up to cfg.ShutdownTimeout,\ndefault: 15s)

Requests -> Requests: Complete processing
Requests --> Server: All requests complete
deactivate Requests

Server --> Main: Shutdown complete (nil or error)
deactivate Server

alt Shutdown successful
    Main -> Main: log.Info("server stopped gracefully")
    Main -> Main: os.Exit(0)
else Shutdown error
    Main -> Main: log.Error("shutdown error")
    Main -> Main: os.Exit(1)
end
deactivate Main
deactivate ServerGo

@enduml
