@startuml Request Lifecycle
!theme plain
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor Client
participant "HTTP Server" as Server
box "internal/middleware" #LightBlue
participant "Tracing\nMiddleware\n(OpenTelemetry)" as Tracing
participant "Recovery\nMiddleware" as Recovery
participant "Logging\nMiddleware" as Logging
end box
box "internal/handler" #LightGreen
participant "Handler" as Handler
end box
box "internal/service" #LightYellow
participant "Service" as Service
end box
box "internal/repository" #LightPink
participant "Repository" as Repository
end box
database "Context" as Context

Client -> Server: GET /api/example?name=Go
activate Server

Server -> Tracing: ServeHTTP(w, r)
activate Tracing
Tracing -> Tracing: propagator.Extract(r.Context(), headers)
Tracing -> Tracing: tracer.Start(ctx, spanName)
note right
  Creates OpenTelemetry span
  Extracts W3C Trace Context
  Generates trace ID if new
end note
Tracing -> Context: ctx with span
Tracing -> Tracing: w.Header.Set("X-Trace-ID", span.TraceID())

Tracing -> Recovery: ServeHTTP(w, r.WithContext(ctx))
activate Recovery
Recovery -> Recovery: defer recover()

Recovery -> Logging: ServeHTTP(w, r)
activate Logging
Logging -> Logging: start = time.Now()

Logging -> Handler: ServeHTTP(w, r)
activate Handler
Handler -> Handler: ctx := r.Context()
Handler -> Handler: name := r.URL.Query().Get("name")

Handler -> Service: GetExample(ctx, name)
activate Service
Service -> Service: select { case <-ctx.Done() }
Service -> Context: logger.InfoContext(ctx, "processing request")
note right
  Logs include trace_id
  from context
end note

Service -> Repository: GetExampleData(ctx, name)
activate Repository
Repository -> Repository: select { case <-ctx.Done() }
Repository -> Context: logger.InfoContext(ctx, "fetching data")
Repository -> Repository: Build response data
Repository --> Service: model.ExampleResponse, nil
deactivate Repository

Service -> Service: Apply business logic
Service --> Handler: result, nil
deactivate Service

Handler -> Handler: writeJSON(w, 200, result)
Handler --> Logging: return
deactivate Handler

Logging -> Logging: duration := time.Since(start)
Logging -> Context: logger.InfoContext(ctx, "http request", ...)
note right
  Logs: method, path, status,
  duration, OpenTelemetry trace_id
end note
Logging --> Recovery: return
deactivate Logging

Recovery --> Tracing: return
deactivate Recovery

Tracing -> Tracing: span.SetAttributes(status_code)
Tracing -> Tracing: span.End()
note right
  Records span completion
  Exports to OTLP endpoint
end note
Tracing --> Server: return
deactivate Tracing

Server --> Client: 200 OK + JSON body
note left
  Headers:
  X-Trace-ID: 0123456789abcdef0123456789abcdef
  (W3C Trace Context format - 32 hex chars)
  Content-Type: application/json
end note
deactivate Server

@enduml
